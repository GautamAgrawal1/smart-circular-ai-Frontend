<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"/>
<title>Smart Circular Economy AI</title>

<script src="https://cdn.tailwindcss.com"></script>

<script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
.fade-in{animation:fade .8s ease}
@keyframes fade{from{opacity:0;transform:translateY(12px)}to{opacity:1}}

.hero{
  min-height:100vh;
  background:
  linear-gradient(rgba(0,0,0,.45),rgba(0,0,0,.45)),
  url("https://images.unsplash.com/photo-1528323273322-d81458248d40?q=80&w=1600&auto=format&fit=crop");
  background-size:cover;
  background-position:center;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:30px;
}

.glass{
  background:rgba(255,255,255,.9);
  backdrop-filter:blur(12px);
  border-radius:18px;
  box-shadow:0 20px 40px rgba(0,0,0,.25);
}

.page-card{
  background:#fff;
  border-radius:16px;
  padding:26px;
  box-shadow:0 12px 30px rgba(0,0,0,.12);
}

.ui-input{
  width:100%;
  padding:10px 12px;
  border-radius:10px;
  border:1px solid #e5e7eb;
  outline:none;
  background:#f9fafb;
}

.ui-input:focus{
  border-color:#22c55e;
  box-shadow:0 0 0 3px rgba(34,197,94,.15);
  background:#fff;
}

.btn-main{
  background:linear-gradient(135deg,#22c55e,#16a34a);
  color:white;
  padding:10px 18px;
  border-radius:10px;
  font-weight:600;
}

.btn-blue{
  background:linear-gradient(135deg,#2563eb,#1d4ed8);
  color:white;
  padding:10px 18px;
  border-radius:10px;
  font-weight:600;
}

.section-title{
  font-size:1.3rem;
  font-weight:700;
  color:#065f46;
  margin-bottom:6px;
}

.stat-card{
  background:linear-gradient(180deg,#ffffff,#f0fdf4);
  border-radius:14px;
  padding:14px;
  text-align:center;
  box-shadow:0 6px 16px rgba(0,0,0,.08);
}
</style>
</head>

<body class="bg-slate-100">

<div id="root"></div>

<script type="text/babel">

/* ✅ DEPLOYED BACKEND URL (NO SPACE, NO LOCALHOST) */
const API = "https://smart-circular-ai-backend-1.onrender.com";

function App(){

  const [token,setToken]=React.useState(localStorage.getItem("token"));
  const [page,setPage]=React.useState(token?"analyze":"landing");

  const logout=()=>{
    localStorage.removeItem("token");
    setToken(null);
    setPage("landing");
  };

  return(
    <div>

      {page==="landing" && <LandingPage setPage={setPage}/>}

      {page!=="landing" && (
        <div className="max-w-6xl mx-auto p-6 fade-in">

          <div className="glass p-6">

            <div className="flex mb-5">
              <h1 className="text-2xl font-bold text-green-700">
                Smart Circular Economy AI
              </h1>

              {token && (
                <div className="ml-auto flex gap-2">
                  <NavBtn onClick={()=>setPage("analyze")}>Analyze</NavBtn>
                  <NavBtn onClick={()=>setPage("history")}>History</NavBtn>
                  <NavBtn onClick={()=>setPage("eco")}>Sustainability</NavBtn>
                  <NavBtn onClick={logout}>Logout</NavBtn>
                </div>
              )}
            </div>

            {!token && page==="login" && <Login setToken={setToken} setPage={setPage}/>}
            {!token && page==="register" && <Register setPage={setPage}/>}

            {token && page==="analyze" && <Analyzer token={token}/>}
            {token && page==="history" && <History token={token}/>}
            {token && page==="eco" && <SustainabilityPage/>}

          </div>

        </div>
      )}

    </div>
  );
}

function NavBtn({children,onClick}){
  return(
    <button onClick={onClick}
      className="px-3 py-1 rounded bg-green-600 text-white hover:bg-green-700">
      {children}
    </button>
  );
}

/* ---------------- Landing ---------------- */

function LandingPage({setPage}){
  return(
    <div className="hero fade-in">
      <div className="glass max-w-5xl p-10">

        <h1 className="text-4xl font-bold text-green-700 text-center mb-4">
          Smart Circular Economy AI
        </h1>

        <p className="text-center text-gray-700 mb-8">
          Building a zero-waste ecosystem using AI-driven reuse, repair and recycling.
        </p>

        <div className="grid md:grid-cols-2 gap-6 mb-8">

          <Feature title="Our initiative">
            Reduce electronic waste using AI based product lifecycle analysis and connect
            users with local sustainability services.
          </Feature>

          <Feature title="Why it matters">
            Extending product life reduces carbon emissions and conserves natural resources.
          </Feature>

          <Feature title="How AI helps">
            Computer vision, predictive models and geo-recommendation enable smart decisions.
          </Feature>

          <Feature title="Circular flow">
            Upload → analyze → life prediction → fair pricing → reuse / repair / recycle →
            nearby facilities.
          </Feature>

        </div>

        <div className="flex justify-center gap-6">
          <button className="btn-blue" onClick={()=>setPage("login")}>Login</button>
          <button className="btn-main" onClick={()=>setPage("register")}>Register</button>
        </div>

      </div>
    </div>
  );
}

function Feature({title,children}){
  return(
    <div className="stat-card text-left">
      <h3 className="font-semibold text-green-700 mb-1">{title}</h3>
      <p className="text-sm text-gray-600">{children}</p>
    </div>
  );
}

/* ---------------- Login ---------------- */

function Login({setToken,setPage}){

  const [email,setEmail]=React.useState("");
  const [password,setPassword]=React.useState("");

  const login=async()=>{
    const fd=new URLSearchParams();
    fd.append("username",email);
    fd.append("password",password);

    const res=await fetch(API+"/auth/login",{
      method:"POST",
      headers:{"Content-Type":"application/x-www-form-urlencoded"},
      body:fd
    });

    const data=await res.json();

    if(!res.ok){
      alert(
        typeof data.detail === "string"
          ? data.detail
          : data.detail?.message || "Login failed"
      );
      return;
    }

    localStorage.setItem("token",data.access_token);
    setToken(data.access_token);
    setPage("analyze");
  };

  return(
    <div className="page-card max-w-md mx-auto fade-in space-y-3">
      <h2 className="section-title text-center">Login</h2>
      <input className="ui-input" placeholder="Email" value={email}
        onChange={e=>setEmail(e.target.value)}/>
      <input className="ui-input" type="password" placeholder="Password" value={password}
        onChange={e=>setPassword(e.target.value)}/>
      <button className="btn-blue w-full" onClick={login}>Login</button>
      <p className="text-sm text-center">
        No account? <span className="text-blue-600 cursor-pointer"
        onClick={()=>setPage("register")}>Register</span>
      </p>
    </div>
  );
}

/* ---------------- Register ---------------- */

function Register({setPage}){

  const [email,setEmail]=React.useState("");
  const [password,setPassword]=React.useState("");

  const register=async()=>{
    const res=await fetch(
      API+`/auth/register?email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`,
      {method:"POST"}
    );

    const data=await res.json();

    if(!res.ok){
      alert(data.detail||"Failed");
      return;
    }

    alert("Registered successfully");
    setPage("login");
  };

  return(
    <div className="page-card max-w-md mx-auto fade-in space-y-3">
      <h2 className="section-title text-center">Create account</h2>
      <input className="ui-input" placeholder="Email" value={email}
        onChange={e=>setEmail(e.target.value)}/>
      <input className="ui-input" type="password" placeholder="Password" value={password}
        onChange={e=>setPassword(e.target.value)}/>
      <button className="btn-main w-full" onClick={register}>Register</button>
    </div>
  );
}

/* ---------------- Analyzer ---------------- */

function Analyzer({token}){

  const [image,setImage]=React.useState(null);
  const [loading,setLoading]=React.useState(false);
  const [result,setResult]=React.useState(null);

  const [form,setForm]=React.useState({
    age_months:24,usage_level:2,base_price:60000,
    demand_level:2,lat:25.3176,lon:82.9739
  });

  const change=e=>setForm({...form,[e.target.name]:e.target.value});

  const submit = async () => {

    if (!image) {
      alert("Upload image");
      return;
    }

    const fd = new FormData();
    fd.append("image", image);
    Object.keys(form).forEach(k => fd.append(k, form[k]));

    setLoading(true);

    try {

      const res = await fetch(API + "/analyze-product", {
        method: "POST",
        headers: {
          Authorization: "Bearer " + token
        },
        body: fd
      });

      const data = await res.json();

      if (!res.ok) {
        alert(data.detail || "Server error");
        return;
      }

      setResult(data);

    } catch (err) {

      console.error(err);
      alert("Backend not reachable / network error");

    } finally {

      setLoading(false);

    }
  };

  React.useEffect(()=>{
    if(!result||!window.L)return;
    if(window._map)window._map.remove();

    const map=L.map("map").setView([form.lat,form.lon],13);
    window._map=map;

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
    L.marker([form.lat,form.lon]).addTo(map);

    result.recommended_places.forEach(p=>{
      const la=(Math.random()-0.5)*0.02;
      const lo=(Math.random()-0.5)*0.02;
      L.marker([+form.lat+la,+form.lon+lo]).addTo(map)
       .bindPopup(p.name+" ("+p.distance_km+" km)");
    });
  },[result]);

  return(
    <div className="fade-in space-y-4">

      <h2 className="section-title">Product analysis</h2>

      <input type="file" className="ui-input"
        onChange={e=>setImage(e.target.files[0])}/>

      <div className="grid md:grid-cols-3 gap-2">
        {Object.keys(form).map(k=>(
          <input key={k} name={k} value={form[k]}
            onChange={change}
            className="ui-input"/>
        ))}
      </div>

      <button className="btn-blue" onClick={submit}>Analyze</button>

      {loading && <p>Processing...</p>}

      {result && (
        <div className="space-y-4">

          <div className="grid md:grid-cols-3 gap-3">
            <Stat t="Category" v={result.detected_category}/>
            <Stat t="Condition" v={result.condition}/>
            <Stat t="Life" v={result.remaining_life_months}/>
            <Stat t="Price" v={"₹ "+result.recommended_price}/>
            <Stat t="Action" v={result.action}/>
            <Stat t="Confidence" v={result.category_confidence}/>
          </div>

          <ul className="list-disc ml-5">
            {result.recommended_places.map((p,i)=>(
              <li key={i}>{p.name} – {p.distance_km} km</li>
            ))}
          </ul>

          <div id="map" className="h-72 rounded"></div>

        </div>
      )}

    </div>
  );
}

function Stat({t,v}){
  return(
    <div className="stat-card">
      <div className="text-xs text-gray-500">{t}</div>
      <div className="font-semibold">{v}</div>
    </div>
  );
}

/* ---------------- History ---------------- */

function History({token}){

  const [rows,setRows]=React.useState([]);

  React.useEffect(()=>{
    fetch(API+"/me/history",{headers:{Authorization:"Bearer "+token}})
      .then(r=>r.json())
      .then(setRows);
  },[]);

  return(
    <div className="fade-in">

      <h2 className="section-title mb-3">My history</h2>

      <div className="overflow-auto">
        <table className="w-full text-sm border">
          <thead className="bg-slate-200">
            <tr>
              <th className="border p-1">Category</th>
              <th className="border p-1">Condition</th>
              <th className="border p-1">Life</th>
              <th className="border p-1">Price</th>
              <th className="border p-1">Action</th>
              <th className="border p-1">Date</th>
            </tr>
          </thead>
          <tbody>
            {rows.map(r=>(
              <tr key={r.id}>
                <td className="border p-1">{r.detected_category}</td>
                <td className="border p-1">{r.condition}</td>
                <td className="border p-1">{r.remaining_life}</td>
                <td className="border p-1">{r.price}</td>
                <td className="border p-1">{r.action}</td>
                <td className="border p-1">
                  {new Date(r.created_at).toLocaleString()}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

    </div>
  );
}

/* ---------------- Sustainability ---------------- */

function SustainabilityPage(){

  return(
    <div className="fade-in space-y-4">

      <h2 className="section-title">Sustainability ecosystem</h2>

      <p>
        This platform enables a circular economy by connecting users,
        repair services and recycling facilities using AI-driven decisions.
      </p>

      <ul className="list-disc ml-5 text-gray-700">
        <li>Computer vision based condition estimation</li>
        <li>Remaining life prediction</li>
        <li>Dynamic resale pricing</li>
        <li>Geo-based facility recommendation</li>
        <li>Scalable multi-category architecture</li>
      </ul>

      <div className="stat-card text-left">
        Upload → AI analysis → life prediction → fair pricing →
        reuse / repair / recycle → nearby facilities
      </div>

    </div>
  );
}

const root=ReactDOM.createRoot(document.getElementById("root"));
root.render(<App/>);

</script>
</body>
</html>
